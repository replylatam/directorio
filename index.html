<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Authenticator Cloud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- QR + TOTP -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/otplib@12.0.1/dist/otplib.umd.min.js"></script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:24px; }
    .top { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; gap:12px; }
    .container { max-width:1100px; margin:auto; }
    .card { background:#020617; border:1px solid #1e293b; border-radius:14px; padding:16px; margin-bottom:12px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media(max-width: 900px){ .grid2{ grid-template-columns: 1fr; } }

    button { background:#6366f1; border:none; color:white; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.secondary { background:#1e293b; }
    button.danger { background:#ef4444; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    input, select, textarea {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #1e293b;
      background:#020617;
      color:white;
      margin-bottom:10px;
      outline:none;
    }
    textarea { min-height: 70px; resize: vertical; }

    .totp { font-size:28px; letter-spacing:3px; margin-top:6px; font-variant-numeric: tabular-nums; }
    .small { font-size:12px; color:#94a3b8; }
    .muted { color:#94a3b8; }
    .divider { height:1px; background:#1e293b; margin:12px 0; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #1e293b; background:#0b1223; font-size:12px; color:#c7d2fe; }
    .progress { height:10px; border:1px solid #1e293b; border-radius:999px; overflow:hidden; background:#0b1223; margin-top:10px; }
    .bar { height:100%; width:0%; background:#6366f1; transition: width .2s linear; }

    .toast {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: #0b1223;
      border: 1px solid #1e293b;
      padding: 10px 14px;
      border-radius: 12px;
      color: #e5e7eb;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:none;
      max-width: 92vw;
      z-index: 99;
    }
  </style>
</head>

<body>
  <div class="top">
    <strong>Authenticator Cloud</strong>
    <div class="row" style="gap:10px; justify-content:flex-end;">
      <span class="small" id="whoami"></span>
      <button id="loginBtn">Login con Google</button>
      <button id="logoutBtn" class="secondary" style="display:none;">Salir</button>
    </div>
  </div>

  <div class="container" id="app">Cargando…</div>
  <div class="toast" id="toast"></div>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBBrsdfpWlrEbxXHTvOzX4X8wXpNagWenA",
  authDomain: "directorio-c2ee0.firebaseapp.com",
  databaseURL: "https://directorio-c2ee0-default-rtdb.firebaseio.com",
  projectId: "directorio-c2ee0"
});

const auth = firebase.auth();
const db = firebase.database();

const ADMIN_EMAIL = "alan.pereyra@replylatam.com";
const USERS_PATH = "usersByEmail";
const CLIENTS_PATH = "clients";

/* ================= TOTP ================= */
const OTP = (window.otplib && window.otplib.authenticator) ? window.otplib.authenticator : null;
if (!OTP) throw new Error("otplib no cargó. Revisá Network: otplib.umd.min.js");
OTP.options = { step: 30 };

/* ================= Helpers ================= */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(() => t.style.display = "none", 2600);
}

function setWhoami(text){ document.getElementById("whoami").textContent = text || ""; }

function showLoginUI(isLoggedIn){
  document.getElementById("loginBtn").style.display = isLoggedIn ? "none" : "inline-block";
  document.getElementById("logoutBtn").style.display = isLoggedIn ? "inline-block" : "none";
}

function isEmailValid(email){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email||"").trim());
}

// keys RTDB no aceptan "."
function emailToKey(email){
  return String(email||"").trim().toLowerCase().replaceAll(".", ",");
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function normalizeSecret(input){
  let s = String(input||"").trim();
  if (!s) return "";

  // Si viene otpauth://... extraer secret=
  if (/^otpauth:\/\//i.test(s)) {
    const m = s.match(/(?:\?|&)secret=([^&\s]+)/i);
    if (m && m[1]) s = decodeURIComponent(m[1]);
  }

  s = s.replace(/\s+/g, "").toUpperCase();
  // base32 típico A-Z2-7, a veces "="
  s = s.replace(/[^A-Z2-7=]/g, "");
  s = s.replace(/=+$/g, "");
  return s;
}

function getRemaining(step=30){
  const now = Math.floor(Date.now()/1000);
  return step - (now % step);
}

/* ================= Auth ================= */
document.getElementById("loginBtn").onclick = () => {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
};
document.getElementById("logoutBtn").onclick = async () => {
  await auth.signOut();
};

auth.onAuthStateChanged(user => {
  const app = document.getElementById("app");

  if (!user) {
    showLoginUI(false);
    setWhoami("");
    app.innerHTML = `
      <div class="card">
        <h2>Ingresar</h2>
        <p class="muted">Iniciá sesión con Google para ver el panel.</p>
        <div class="divider"></div>
        <button onclick="document.getElementById('loginBtn').click()">Login con Google</button>
      </div>
    `;
    return;
  }

  showLoginUI(true);
  setWhoami(user.email);

  if (user.email !== ADMIN_EMAIL) {
    app.innerHTML = `
      <div class="card">
        <h2>Solo Admin (por ahora)</h2>
        <p class="muted">Tu mail es <b>${escapeHtml(user.email)}</b>. Esta versión está enfocada en la vista Admin.</p>
      </div>
    `;
    return;
  }

  renderAdmin(user);
});

/* ================= Admin UI ================= */
function renderAdmin(user){
  const app = document.getElementById("app");
  app.innerHTML = `
    <div class="card">
      <div class="row">
        <div>
          <h2 style="margin:0 0 6px 0;">Panel Admin</h2>
          <div class="small">${escapeHtml(user.email)} <span class="pill">admin</span></div>
        </div>
        <div>
          <button onclick="showCreateClient()">+ Nuevo cliente</button>
        </div>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <h3 style="margin-top:0;">Usuarios</h3>
        <p class="small">Agregá/eliminá usuarios (operadores u otros admins).</p>
        <div class="divider"></div>

        <input id="uEmail" placeholder="Email (ej: acco@replylatam.com)">
        <select id="uRole">
          <option value="operator">operator</option>
          <option value="admin">admin</option>
        </select>

        <button id="addUserBtn" onclick="addUser()">Agregar usuario</button>

        <div class="divider"></div>
        <div id="usersList" class="small muted">Cargando usuarios…</div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">Clientes</h3>
        <p class="small">Códigos TOTP en vivo (renuevan cada 30s).</p>
        <div class="divider"></div>
        <div id="clients" class="small muted">Cargando clientes…</div>
      </div>
    </div>
  `;

  loadUsers();
  loadClients();
}

/* ================= Users CRUD ================= */
function loadUsers(){
  const el = document.getElementById("usersList");

  db.ref(USERS_PATH).on("value", snap => {
    const data = snap.val();
    const users = data ? Object.entries(data).map(([k,v]) => ({key:k, ...v})) : [];

    users.sort((a,b) => (a.email||"").localeCompare(b.email||""));

    if (users.length === 0) {
      el.innerHTML = `<div class="muted">No hay usuarios cargados.</div>`;
      return;
    }

    el.innerHTML = users.map(u => `
      <div class="card" style="padding:12px; margin-bottom:10px;">
        <div class="row" style="align-items:flex-start;">
          <div style="flex:1;">
            <div><b>${escapeHtml(u.email||"")}</b> <span class="pill">${escapeHtml(u.role||"operator")}</span></div>
            <div class="small">${escapeHtml(u.createdAt||"")}</div>
          </div>
          <div>
            <button class="danger" onclick="deleteUser('${escapeHtml(u.email||"")}')">Eliminar</button>
          </div>
        </div>
      </div>
    `).join("");
  });
}

async function addUser(){
  const btn = document.getElementById("addUserBtn");
  const email = String(document.getElementById("uEmail").value||"").trim().toLowerCase();
  const role = String(document.getElementById("uRole").value||"operator");

  if (!isEmailValid(email)) return alert("Email inválido.");
  if (!["admin","operator"].includes(role)) return alert("Rol inválido.");
  if (email === ADMIN_EMAIL) return alert("Ese email ya es admin fijo.");

  btn.disabled = true;
  btn.textContent = "Agregando…";

  try {
    await db.ref(`${USERS_PATH}/${emailToKey(email)}`).set({
      email,
      role,
      createdAt: new Date().toISOString()
    });
    document.getElementById("uEmail").value = "";
    toast("Usuario agregado");
  } catch (e) {
    console.error(e);
    alert("Error al agregar usuario: " + (e?.message || e) + "\n\nSi dice PERMISSION_DENIED: son las Rules.");
  } finally {
    btn.disabled = false;
    btn.textContent = "Agregar usuario";
  }
}

async function deleteUser(email){
  email = String(email||"").trim().toLowerCase();
  if (!email) return;
  if (email === ADMIN_EMAIL) return alert("No se puede eliminar el admin fijo.");
  if (!confirm("¿Eliminar usuario " + email + "?")) return;

  try {
    await db.ref(`${USERS_PATH}/${emailToKey(email)}`).remove();
    toast("Usuario eliminado");
  } catch (e) {
    console.error(e);
    alert("Error al eliminar usuario: " + (e?.message || e));
  }
}

/* ================= Clients ================= */
function loadClients(){
  const container = document.getElementById("clients");

  db.ref(CLIENTS_PATH).on("value", snap => {
    const data = snap.val();
    if (!data) {
      container.innerHTML = `<div class="muted">Sin clientes</div>`;
      return;
    }

    container.innerHTML = "";
    snap.forEach(child => {
      const id = child.key;
      const c = child.val();
      renderClient(id, c, container);
    });
  });
}

function renderClient(id, c, container){
  const div = document.createElement("div");
  div.className = "card";

  const secret = normalizeSecret(c?.secret || "");
  const name = escapeHtml(c?.name || "");
  const operator = escapeHtml(c?.operator || "");
  const createdAt = escapeHtml(c?.createdAt || "");

  div.innerHTML = `
    <b>${name}</b>
    <div class="small">Operador: ${operator}</div>
    <div class="small">Creado: ${createdAt}</div>

    <div class="totp" id="code-${id}">------</div>
    <div class="small muted" id="ttl-${id}"></div>
    <div class="progress"><div class="bar" id="bar-${id}"></div></div>

    <div class="divider"></div>
    <button class="danger" onclick="deleteClient('${id}', '${name}')">Eliminar cliente</button>
  `;

  container.appendChild(div);

  const codeEl = div.querySelector(`#code-${CSS.escape(id)}`);
  const ttlEl  = div.querySelector(`#ttl-${CSS.escape(id)}`);
  const barEl  = div.querySelector(`#bar-${CSS.escape(id)}`);

  const tick = () => {
    const remain = getRemaining(30);
    ttlEl.textContent = `Renueva en ${remain}s`;
    barEl.style.width = `${((30 - remain) / 30) * 100}%`;

    if (!secret) {
      codeEl.textContent = "SIN SECRET";
      return;
    }
    try {
      codeEl.textContent = OTP.generate(secret);
    } catch {
      codeEl.textContent = "ERROR";
    }
  };

  tick();
  const interval = setInterval(tick, 1000);

  // limpiar interval si se remueve el nodo
  const obs = new MutationObserver(() => {
    if (!document.body.contains(div)) { clearInterval(interval); obs.disconnect(); }
  });
  obs.observe(document.body, { childList:true, subtree:true });
}

async function deleteClient(id, name){
  if (!confirm(`¿Eliminar cliente "${name || id}"?`)) return;
  try {
    await db.ref(`${CLIENTS_PATH}/${id}`).remove();
    toast("Cliente eliminado");
  } catch (e) {
    console.error(e);
    alert("Error al eliminar cliente: " + (e?.message || e));
  }
}

/* ================= Create Client ================= */
function showCreateClient(){
  // evita duplicar
  if (document.getElementById("createCard")) return;

  document.getElementById("app").insertAdjacentHTML("afterbegin", `
    <div class="card" id="createCard">
      <h3 style="margin-top:0;">Nuevo cliente</h3>

      <input id="cName" placeholder="Nombre (ej: American Confort)">
      <input id="cOperator" placeholder="Email operador (ej: acco@replylatam.com)">
      <input id="cQr" placeholder="Link del QR (Google Drive)">

      <p class="small muted">
        Si Drive bloquea lectura (CORS), pegá abajo el <b>otpauth://...</b> o el <b>secret</b> (funciona 100%).
      </p>
      <textarea id="cManual" placeholder="Opcional: otpauth://totp/...&secret=XXXX o secret base32"></textarea>

      <button id="saveBtn" onclick="saveClient()">Guardar</button>
      <button class="secondary" onclick="document.getElementById('createCard').remove()">Cancelar</button>
    </div>
  `);
}

async function saveClient(){
  const btn = document.getElementById("saveBtn");
  const name = String(document.getElementById("cName").value||"").trim();
  const operator = String(document.getElementById("cOperator").value||"").trim().toLowerCase();
  const qrUrl = String(document.getElementById("cQr").value||"").trim();
  const manual = String(document.getElementById("cManual").value||"").trim();

  if (!name) return alert("Falta nombre.");
  if (!isEmailValid(operator)) return alert("Email operador inválido.");
  if (!qrUrl && !manual) return alert("Pegá un link de Drive o un secret/otpauth manual.");

  btn.disabled = true;
  btn.textContent = "Procesando…";

  try {
    let secret = "";

    // 1) si hay manual, usamos eso
    if (manual) {
      secret = normalizeSecret(manual);
      if (!secret) throw new Error("El secret/otpauth manual no es válido.");
    } else {
      // 2) intentamos leer QR de Drive (puede fallar por CORS)
      btn.textContent = "Leyendo QR…";
      const fileId = extractDriveFileId(qrUrl);
      if (!fileId) throw new Error("No pude extraer el FILE_ID del link de Drive.");

      const imgUrl = `https://drive.google.com/uc?export=view&id=${encodeURIComponent(fileId)}`;
      secret = await readQR(imgUrl);
      secret = normalizeSecret(secret);

      if (!secret) {
        throw new Error(
          "No se pudo leer el QR desde Drive (probable CORS). " +
          "Solución gratis: pegá el otpauth:// o el secret en el campo manual."
        );
      }
    }

    // validar que genera
    OTP.generate(secret);

    btn.textContent = "Guardando…";

    // ✅ FIX: await push, y si falla lo vemos
    await db.ref(CLIENTS_PATH).push({
      name,
      operator,
      qrUrl: qrUrl || "",
      secret,
      createdAt: new Date().toISOString()
    });

    toast("Cliente guardado");
    document.getElementById("createCard").remove();
  } catch (e) {
    console.error(e);
    alert("Error al guardar cliente: " + (e?.message || e));
  } finally {
    btn.disabled = false;
    btn.textContent = "Guardar";
  }
}

/* ================= Drive ID + QR ================= */
function extractDriveFileId(url){
  const u = String(url||"");
  let m = u.match(/\/d\/([a-zA-Z0-9_-]{10,})\//);
  if (m && m[1]) return m[1];
  m = u.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
  if (m && m[1]) return m[1];
  m = u.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
  if (m && m[1]) return m[1];
  return null;
}

function readQR(url){
  return new Promise(resolve => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      try {
        const c = document.createElement("canvas");
        c.width = img.width;
        c.height = img.height;
        const ctx = c.getContext("2d");
        ctx.drawImage(img, 0, 0);
        const imgData = ctx.getImageData(0, 0, c.width, c.height);
        const qr = jsQR(imgData.data, c.width, c.height);
        if (!qr || !qr.data) return resolve(null);
        const m = String(qr.data).match(/(?:\?|&)secret=([^&\s]+)/i);
        resolve(m ? decodeURIComponent(m[1]) : null);
      } catch (err) {
        // esto suele pasar por canvas "tainted" (CORS)
        resolve(null);
      }
    };
    img.onerror = () => resolve(null);
    img.src = url;
  });
}
</script>
</body>
</html>
