<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Authenticator Cloud</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
body{font-family:Inter,system-ui;background:#0f172a;color:#e5e7eb;margin:0;padding:24px}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.container{max-width:1100px;margin:auto}
.card{background:#020617;border:1px solid #1e293b;border-radius:14px;padding:16px;margin-bottom:12px}
button{background:#6366f1;border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer}
button.secondary{background:#1e293b}
input{width:100%;padding:10px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:white;margin-bottom:10px}
.totp{font-size:28px;letter-spacing:3px;margin-top:6px}
.small{font-size:12px;color:#94a3b8}
</style>
</head>
<body>

<div class="container" id="app">
  <div class="card" id="loginScreen">
    <h2>Authenticator Cloud</h2>
    <button id="loginBtn">Iniciar sesi√≥n con Google</button>
  </div>
</div>

<script>

/* ================= TOTP ================= */

function base32ToUint8(base32){
const alphabet="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"
let bits="",result=[]
base32=base32.replace(/=+$/,"").replace(/\s+/g,"").toUpperCase()
for(let i=0;i<base32.length;i++){
const val=alphabet.indexOf(base32[i])
if(val===-1)continue
bits+=val.toString(2).padStart(5,"0")
}
for(let i=0;i+8<=bits.length;i+=8){
result.push(parseInt(bits.substring(i,i+8),2))
}
return new Uint8Array(result)
}

async function generateTOTP(secret){
const key=await crypto.subtle.importKey(
"raw",
base32ToUint8(secret),
{name:"HMAC",hash:"SHA-1"},
false,
["sign"]
)

const epoch=Math.floor(Date.now()/1000)
const time=Math.floor(epoch/30)

const buffer=new ArrayBuffer(8)
const view=new DataView(buffer)
view.setUint32(4,time)

const hmac=await crypto.subtle.sign("HMAC",key,buffer)
const bytes=new Uint8Array(hmac)
const offset=bytes[bytes.length-1]&0xf

const code=((bytes[offset]&0x7f)<<24)|
((bytes[offset+1]&0xff)<<16)|
((bytes[offset+2]&0xff)<<8)|
(bytes[offset+3]&0xff)

return(code%1000000).toString().padStart(6,"0")
}

/* ================= Firebase ================= */

firebase.initializeApp({
apiKey:"AIzaSyBBrsdfpWlrEbxXHTvOzX4X8wXpNagWenA",
authDomain:"directorio-c2ee0.firebaseapp.com",
databaseURL:"https://directorio-c2ee0-default-rtdb.firebaseio.com",
projectId:"directorio-c2ee0"
})

const auth=firebase.auth()
const db=firebase.database()
  
let currentRole = null;
const SUPER_ADMIN_EMAIL = "alan.pereyra@replylatam.com";

/* ================= Login ================= */
document.getElementById("loginBtn").onclick = () => {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
};

auth.onAuthStateChanged(async user => {

  if (!user) return;

  const userRef = db.ref("users").child(user.uid);
  const snap = await userRef.once("value");
  let userData = snap.val();

  // üî• Si es el super admin y no existe en DB ‚Üí crearlo
  if (!userData && user.email === SUPER_ADMIN_EMAIL) {
    await userRef.set({
      email: user.email,
      role: "admin",
      active: true,
      createdAt: new Date().toISOString()
    });

    userData = {
      role: "admin",
      active: true
    };
  }

  if (!userData || !userData.active) {
    alert("No ten√©s permisos para acceder.");
    auth.signOut();
    return;
  }

  renderApp(userData.role, user);
});

/* ================= UI ================= */

function renderApp(role,user){
  
currentRole = role;
  
const app=document.getElementById("app")
app.innerHTML=`
<div class="card">
<h2>${role==="admin"?"Panel Admin":"Panel Operador"}</h2>
<p class="small">${user.email}</p>
${role==="admin"?`<button onclick="showCreate()">+ Nuevo cliente</button>`:""}
</div>
<div id="clients"></div>
`
loadClients(role,user.email)
}

/* ================= Clientes ================= */

function loadClients(role,email){
  const container=document.getElementById("clients")

  db.ref("clients").on("value",snap=>{
    container.innerHTML=""
    const data=snap.val()
    if(!data){
      container.innerHTML="<p>Sin clientes</p>"
      return
    }

    Object.entries(data).forEach(([id,c])=>{
      if(role==="admin" || c.operator===email){
        renderClient(c,container,id)
      }
    })
  })
}


function renderClient(c, container, id) {

  if ((c.active === false) && currentRole === "operator") return;

  const div = document.createElement("div");
  div.className = "card";

  const codeId = "code-" + id;
  const timerId = "timer-" + id;

  const fecha = c.createdAt 
  ? new Date(c.createdAt).toLocaleString() 
  : "Fecha desconocida";

  div.innerHTML = `
    <strong>${c.name}</strong>
    <div class="small">Creado: ${fecha}</div>
    <div class="small">Estado: ${c.active ? "Activo" : "Inactivo"}</div>
    <div class="totp" id="${codeId}">------</div>
    <div class="small">
      Operador: ${c.operator || "No asignado"}<br>
      Vence en: <span id="${timerId}">30</span>s
    </div>
    ${currentRole === "admin" ? `
      <button onclick="toggleClient('${id}', ${c.active})">
        ${c.active ? "Apagar" : "Encender"}
      </button>
      <button onclick="editClient('${id}')">Editar</button>
    ` : ""}
  `;

  container.appendChild(div);

  if (!c.secret) return;

  async function updateCode(){
    const token = await generateTOTP(c.secret);
    document.getElementById(codeId).innerText = token;
  }

  function updateTimer(){
    const seconds = 30 - (Math.floor(Date.now()/1000)%30);
    document.getElementById(timerId).innerText = seconds;
  }

  updateCode();
  updateTimer();

  setInterval(updateTimer,1000);
  setInterval(()=>{
    const seconds=Math.floor(Date.now()/1000);
    if(seconds%30===0) updateCode();
  },1000);
}


/* ================= Crear Cliente ================= */

function showCreate(){
document.getElementById("app").insertAdjacentHTML("afterbegin",`
<div class="card">
<h3>Nuevo cliente</h3>
<input id="cName" placeholder="Nombre">
<input id="cOperator" placeholder="Email operador">
<input type="file" id="qrFile" accept="image/*">
<button onclick="extractSecret()">Extraer SECRET</button>
<div id="secretPreview" class="small"></div>
<button onclick="saveClient()">Guardar cliente</button>
<button class="secondary" onclick="location.reload()">Cancelar</button>
</div>
`)
}

let extractedSecret = null;

async function extractSecret() {
  const fileInput = document.getElementById("qrFile");
  const file = fileInput.files[0];

  if (!file) {
    alert("Seleccion√° una imagen QR");
    return;
  }

  const reader = new FileReader();

  reader.onload = function(e) {
    const img = new Image();

    img.onload = function() {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const qr = jsQR(imageData.data, canvas.width, canvas.height);

      if (!qr) {
        alert("No se pudo leer el QR");
        return;
      }

      const match = qr.data.match(/secret=([A-Z0-9]+)/i);

      if (!match) {
        alert("No se encontr√≥ SECRET en el QR");
        return;
      }

      extractedSecret = match[1];

      document.getElementById("secretPreview").innerText =
        "SECRET detectado: " + extractedSecret;
    };

    img.src = e.target.result;
  };

  reader.readAsDataURL(file);
}
async function toggleClient(id, currentState){
  await db.ref("clients").child(id).update({
    active: !currentState
  });
}

  async function editClient(id){
  const snap = await db.ref("clients").child(id).once("value");
  const c = snap.val();

  const newName = prompt("Nuevo nombre:", c.name);
  const newOperator = prompt("Nuevo operador:", c.operator);

  if(!newName || !newOperator) return;

  await db.ref("clients").child(id).update({
    name: newName,
    operator: newOperator
  });
}


  async function saveClient() {

  if (!extractedSecret) {
    alert("Primero extra√© el SECRET");
    return;
  }

  const name = document.getElementById("cName").value.trim();
  const operator = document.getElementById("cOperator").value.trim();

  if (!name || !operator) {
    alert("Complet√° todos los campos");
    return;
  }

  await db.ref("clients").push({
    name,
    operator,
    secret: extractedSecret,
    active: true,
    createdAt: new Date().toISOString()
    
  });

  alert("Cliente creado correctamente");

  extractedSecret = null;

  location.reload();
}



</script>
</body>
</html>
