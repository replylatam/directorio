<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Authenticator Cloud</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- QR + TOTP -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/otplib@12.0.1/dist/otplib.umd.min.js"></script>

<style>
  body {
    font-family: Inter, system-ui, sans-serif;
    background:#0f172a;
    color:#e5e7eb;
    margin:0;
    padding:24px;
  }
  .top {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    gap:12px;
  }
  .container { max-width:1100px; margin:auto; }
  .card {
    background:#020617;
    border:1px solid #1e293b;
    border-radius:14px;
    padding:16px;
    margin-bottom:12px;
  }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .col { flex:1; min-width:240px; }
  button {
    background:#6366f1;
    border:none;
    color:white;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
  }
  button.secondary { background:#1e293b; }
  button.danger { background:#ef4444; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  input, select, textarea {
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid #1e293b;
    background:#020617;
    color:white;
    margin-bottom:10px;
    outline:none;
  }
  textarea { min-height: 70px; resize: vertical; }
  .totp {
    font-size:30px;
    letter-spacing:4px;
    margin-top:10px;
    font-variant-numeric: tabular-nums;
  }
  .small { font-size:12px; color:#94a3b8; }
  .muted { color:#94a3b8; }
  .pill {
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid #1e293b;
    background:#0b1223;
    font-size:12px;
    color:#c7d2fe;
  }
  .divider { height:1px; background:#1e293b; margin:12px 0; }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media(max-width: 900px){ .grid2{ grid-template-columns: 1fr; } }
  .progress {
    height: 10px;
    border: 1px solid #1e293b;
    border-radius: 999px;
    overflow: hidden;
    background: #0b1223;
    margin-top: 10px;
  }
  .bar {
    height: 100%;
    width: 0%;
    background: #6366f1;
    transition: width .2s linear;
  }
  .toast {
    position: fixed;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    background: #0b1223;
    border: 1px solid #1e293b;
    padding: 10px 14px;
    border-radius: 12px;
    color: #e5e7eb;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    display:none;
    max-width: 92vw;
    z-index: 99;
  }
</style>
</head>

<body>
  <div class="top">
    <strong>Authenticator Cloud</strong>
    <div class="row">
      <span class="small" id="whoami"></span>
      <button id="loginBtn">Login con Google</button>
      <button id="logoutBtn" class="secondary" style="display:none;">Salir</button>
    </div>
  </div>

  <div class="container" id="app">Cargando…</div>
  <div class="toast" id="toast"></div>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBBrsdfpWlrEbxXHTvOzX4X8wXpNagWenA",
  authDomain: "directorio-c2ee0.firebaseapp.com",
  databaseURL: "https://directorio-c2ee0-default-rtdb.firebaseio.com",
  projectId: "directorio-c2ee0"
});

const auth = firebase.auth();
const db = firebase.database();

const ADMIN_EMAIL = "alan.pereyra@replylatam.com";
const USERS_PATH = "usersByEmail";
const CLIENTS_PATH = "clients";

/* TOTP options */
otplib.authenticator.options = { step: 30 };

/* ================= Helpers ================= */
function toast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(() => t.style.display = "none", 2600);
}

function escapeHtml(s) {
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function emailToKey(email) {
  return String(email || "").trim().toLowerCase().replaceAll(".", ",");
}

function isEmailValid(email){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email||"").trim());
}

function setWhoami(text){
  document.getElementById("whoami").textContent = text || "";
}

function showLoginUI(show){
  document.getElementById("loginBtn").style.display = show ? "inline-block" : "none";
  document.getElementById("logoutBtn").style.display = show ? "none" : "inline-block";
}

// Limpia/normaliza secrets para evitar "ERROR"
function normalizeSecret(secret){
  let s = String(secret || "").trim();
  if (!s) return "";

  // si viene otpauth://..., extraer secret
  if (/^otpauth:\/\//i.test(s)) {
    const m = s.match(/(?:\?|&)secret=([^&\s]+)/i);
    if (m && m[1]) s = decodeURIComponent(m[1]);
  }

  // base32 típico: A-Z2-7 y a veces "=" de padding
  s = s.replace(/\s+/g, "");
  s = s.toUpperCase();
  s = s.replace(/[^A-Z2-7=]/g, "");

  // muchos secrets funcionan mejor sin "="
  s = s.replace(/=+$/g, "");

  return s;
}

function getRemaining(step=30){
  const now = Math.floor(Date.now() / 1000);
  const mod = now % step;
  return step - mod;
}

/* ================= Login ================= */
document.getElementById("loginBtn").onclick = () => {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
};

document.getElementById("logoutBtn").onclick = async () => {
  await auth.signOut();
};

auth.onAuthStateChanged(async user => {
  const app = document.getElementById("app");

  if (!user) {
    showLoginUI(true);
    setWhoami("");
    app.innerHTML = `
      <div class="card">
        <h2>Ingresar</h2>
        <p class="muted">Primero iniciá sesión con Google. Luego aparecen opciones según tu mail.</p>
        <div class="divider"></div>
        <button onclick="document.getElementById('loginBtn').click()">Login con Google</button>
      </div>
    `;
    return;
  }

  showLoginUI(false);
  setWhoami(user.email);

  // Rol (admin fijo por email)
  const isAdmin = (user.email === ADMIN_EMAIL);

  if (!isAdmin) {
    app.innerHTML = `
      <div class="card">
        <h2>Panel Operador (pendiente)</h2>
        <p class="muted">Por ahora trabajamos solo la vista Admin.</p>
      </div>
    `;
    return;
  }

  renderAdmin(user);
});

/* ================= Admin UI ================= */
function renderAdmin(user){
  const app = document.getElementById("app");
  app.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h2 style="margin:0 0 6px 0;">Panel Admin</h2>
          <div class="small">${escapeHtml(user.email)} <span class="pill">admin</span></div>
        </div>
        <div class="row">
          <button onclick="showCreateClient()">+ Nuevo cliente</button>
        </div>
      </div>
    </div>

    <div class="grid2">
      <div>
        <div class="card">
          <h3 style="margin-top:0;">Usuarios</h3>
          <p class="small">Acá agregás/eliminás usuarios habilitados (operadores u otros admins).</p>

          <div class="divider"></div>

          <div class="row">
            <div class="col">
              <input id="newUserEmail" placeholder="Email (ej: acco@replylatam.com)" />
            </div>
            <div style="min-width:200px;">
              <select id="newUserRole">
                <option value="operator">operator</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <div style="min-width:160px;">
              <button id="addUserBtn" onclick="addUser()">Agregar usuario</button>
            </div>
          </div>

          <div id="usersList" class="small muted">Cargando usuarios…</div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3 style="margin-top:0;">Clientes</h3>
          <p class="small">Listado de clientes + códigos TOTP renovando cada 30s.</p>
          <div id="clients" class="small muted">Cargando clientes…</div>
        </div>
      </div>
    </div>
  `;

  loadUsers();
  loadClientsAdmin();
}

/* ================= Usuarios (Admin) ================= */
function loadUsers(){
  const usersList = document.getElementById("usersList");

  db.ref(USERS_PATH).on("value", snap => {
    const data = snap.val();
    if (!data) {
      usersList.innerHTML = `<p class="muted">No hay usuarios cargados (excepto el admin fijo).</p>`;
      return;
    }

    const rows = Object.values(data)
      .filter(u => u && u.email)
      .sort((a,b) => (a.email||"").localeCompare(b.email||""));

    let html = `
      <div class="divider"></div>
      <div class="small muted" style="margin-bottom:8px;">
        <b>Admin fijo:</b> ${escapeHtml(ADMIN_EMAIL)} (siempre admin)
      </div>
    `;

    rows.forEach(u => {
      const email = u.email || "";
      const role = u.role || "operator";
      const canDelete = email !== ADMIN_EMAIL;
      html += `
        <div class="card" style="margin:0 0 10px 0; padding:12px;">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div><b>${escapeHtml(email)}</b> <span class="pill">${escapeHtml(role)}</span></div>
              <div class="small">${escapeHtml(u.createdAt || "")}</div>
            </div>
            <div>
              <button class="danger" ${canDelete ? "" : "disabled"} onclick="deleteUser('${escapeHtml(email)}')">Eliminar</button>
            </div>
          </div>
        </div>
      `;
    });

    usersList.innerHTML = html;
  });
}

async function addUser(){
  const btn = document.getElementById("addUserBtn");
  const email = String(document.getElementById("newUserEmail").value || "").trim().toLowerCase();
  const role = String(document.getElementById("newUserRole").value || "operator");

  if (!isEmailValid(email)) return alert("Email inválido.");
  if (email === ADMIN_EMAIL) return alert("Ese email ya es admin fijo.");
  if (!["admin","operator"].includes(role)) return alert("Rol inválido.");

  btn.disabled = true;
  btn.textContent = "Agregando…";

  try {
    const key = emailToKey(email);
    await db.ref(`${USERS_PATH}/${key}`).set({
      email,
      role,
      createdAt: new Date().toISOString()
    });
    document.getElementById("newUserEmail").value = "";
    toast("Usuario agregado");
  } catch (e) {
    console.error(e);
    alert(
      "Error al agregar usuario: " +
      (e && e.message ? e.message : e) +
      "\n\nTIP: esto es por Rules. Pegá las Rules que te pasé y recargá."
    );
  } finally {
    btn.disabled = false;
    btn.textContent = "Agregar usuario";
  }
}

async function deleteUser(email){
  email = String(email || "").trim().toLowerCase();
  if (!email) return;
  if (email === ADMIN_EMAIL) return alert("No se puede eliminar el admin fijo.");
  if (!confirm("¿Eliminar usuario " + email + "?")) return;

  try {
    const key = emailToKey(email);
    await db.ref(`${USERS_PATH}/${key}`).remove();
    toast("Usuario eliminado");
  } catch (e) {
    console.error(e);
    alert("Error al eliminar usuario: " + (e && e.message ? e.message : e));
  }
}

/* ================= Clientes (Admin) ================= */
function loadClientsAdmin(){
  const container = document.getElementById("clients");

  db.ref(CLIENTS_PATH).on("value", snap => {
    const data = snap.val();
    if (!data) {
      container.innerHTML = `<p class="muted">Sin clientes</p>`;
      return;
    }

    container.innerHTML = "";
    snap.forEach(child => {
      const id = child.key;
      const c = child.val();
      renderClientCard(id, c, container);
    });
  });
}

function renderClientCard(id, c, container){
  const div = document.createElement("div");
  div.className = "card";

  const safeName = escapeHtml(c?.name || "");
  const safeOp = escapeHtml(c?.operator || "");
  const safeQr = escapeHtml(c?.qrUrl || "");
  const createdAt = escapeHtml(c?.createdAt || "");
  const secretNorm = normalizeSecret(c?.secret || "");

  div.innerHTML = `
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div style="flex:1; min-width:260px;">
        <div><b>${safeName}</b></div>
        <div class="small">Operador: ${safeOp}</div>
        <div class="small">Creado: ${createdAt}</div>
        ${safeQr ? `<div class="small">QR: <span class="muted">${safeQr}</span></div>` : ""}
        <div class="totp" id="code-${id}">------</div>
        <div class="small muted" id="ttl-${id}"></div>
        <div class="progress"><div class="bar" id="bar-${id}"></div></div>
      </div>
      <div class="row">
        <button class="danger" onclick="deleteClient('${id}', '${safeName}')">Eliminar</button>
      </div>
    </div>
  `;

  container.appendChild(div);

  const codeEl = div.querySelector(`#code-${CSS.escape(id)}`);
  const ttlEl  = div.querySelector(`#ttl-${CSS.escape(id)}`);
  const barEl  = div.querySelector(`#bar-${CSS.escape(id)}`);

  const tick = () => {
    const remain = getRemaining(30);
    ttlEl.textContent = `Renueva en ${remain}s`;

    const pct = ((30 - remain) / 30) * 100;
    barEl.style.width = `${pct}%`;

    if (!secretNorm) {
      codeEl.textContent = "SIN SECRET";
      return;
    }
    try {
      codeEl.textContent = otplib.authenticator.generate(secretNorm);
    } catch (err) {
      codeEl.textContent = "ERROR";
      // Si querés ver el motivo exacto:
      // console.warn("TOTP error", id, secretNorm, err);
    }
  };

  tick();
  const interval = setInterval(tick, 1000);

  const obs = new MutationObserver(() => {
    if (!document.body.contains(div)) {
      clearInterval(interval);
      obs.disconnect();
    }
  });
  obs.observe(document.body, { childList:true, subtree:true });
}

async function deleteClient(id, name){
  if (!confirm(`¿Eliminar cliente "${name || id}"?`)) return;
  try {
    await db.ref(`${CLIENTS_PATH}/${id}`).remove();
    toast("Cliente eliminado");
  } catch (e) {
    console.error(e);
    alert("Error al eliminar cliente: " + (e && e.message ? e.message : e));
  }
}

/* ================= Crear Cliente (Admin) ================= */
function showCreateClient() {
  const app = document.getElementById("app");
  const existing = document.getElementById("createClientCard");
  if (existing) { existing.scrollIntoView({behavior:"smooth"}); return; }

  app.insertAdjacentHTML("afterbegin", `
    <div class="card" id="createClientCard">
      <h3 style="margin-top:0;">Nuevo cliente</h3>

      <input id="cName" placeholder="Nombre (ej: American Confort)">
      <input id="cOperator" placeholder="Email operador (ej: acco@replylatam.com)">
      <input id="cQr" placeholder="Link QR Google Drive (view o share link)">

      <div class="divider"></div>
      <p class="small muted">
        ⚠️ Google Drive suele bloquear CORS en GitHub Pages, y puede fallar leer el QR automáticamente.
        Si falla, pegá acá el <b>secret</b> o el <b>otpauth://...</b>:
      </p>
      <textarea id="cSecret" placeholder="Opcional: secret (base32) o otpauth://totp/...&secret=XXXX"></textarea>

      <button id="saveClientBtn" onclick="saveClient()">Guardar</button>
      <button class="secondary" onclick="document.getElementById('createClientCard').remove()">Cancelar</button>
    </div>
  `);
}

async function saveClient() {
  const btn = document.getElementById("saveClientBtn");
  const name = String(document.getElementById("cName").value || "").trim();
  const operator = String(document.getElementById("cOperator").value || "").trim().toLowerCase();
  const qrUrl = String(document.getElementById("cQr").value || "").trim();
  const secretManual = String(document.getElementById("cSecret").value || "").trim();

  if (!name) return alert("Falta el nombre.");
  if (!isEmailValid(operator)) return alert("Email de operador inválido.");
  if (!qrUrl && !secretManual) return alert("Pegá un link de QR o un secret/otpauth manual.");

  btn.disabled = true;
  btn.textContent = "Procesando…";

  try {
    let secret = "";

    // 1) Si pegó secret/otpauth, usamos eso
    if (secretManual) {
      secret = normalizeSecret(secretManual);
      if (!secret) throw new Error("El secret/otpauth manual no contiene un secret válido.");
    } else {
      // 2) Si no, intentamos leer el QR desde Drive (puede fallar por CORS)
      btn.textContent = "Leyendo QR…";
      const fileId = extractDriveFileId(qrUrl);
      if (!fileId) throw new Error("No pude extraer el FILE_ID del link de Google Drive.");
      secret = await readQRFromDriveFileId(fileId);
      secret = normalizeSecret(secret);
      if (!secret) throw new Error("No se pudo leer el QR (probable CORS). Pegá el secret u otpauth manualmente.");
    }

    // Validación rápida: que otplib pueda generar
    try { otplib.authenticator.generate(secret); }
    catch { throw new Error("El secret guardado no es válido para TOTP."); }

    btn.textContent = "Guardando…";
    await db.ref(CLIENTS_PATH).push({
      name,
      operator,
      qrUrl,
      secret,
      createdAt: new Date().toISOString()
    });

    toast("Cliente guardado");
    document.getElementById("createClientCard")?.remove();
  } catch (e) {
    console.error(e);
    alert("Error al guardar cliente: " + (e && e.message ? e.message : e));
  } finally {
    btn.disabled = false;
    btn.textContent = "Guardar";
  }
}

/* ================= Google Drive + QR ================= */
function extractDriveFileId(url){
  const u = String(url || "");
  let m = u.match(/\/d\/([a-zA-Z0-9_-]{10,})\//);
  if (m && m[1]) return m[1];
  m = u.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
  if (m && m[1]) return m[1];
  m = u.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
  if (m && m[1]) return m[1];
  return null;
}

function driveCandidates(fileId){
  return [
    `https://drive.google.com/uc?export=download&id=${encodeURIComponent(fileId)}`,
    `https://drive.google.com/uc?export=view&id=${encodeURIComponent(fileId)}`,
    `https://drive.googleusercontent.com/uc?id=${encodeURIComponent(fileId)}&export=download`,
    `https://lh3.googleusercontent.com/d/${encodeURIComponent(fileId)}`
  ];
}

async function readQRFromDriveFileId(fileId){
  const urls = driveCandidates(fileId);
  for (const url of urls) {
    try {
      const secret = await readQR(url);
      if (secret) return secret;
    } catch (e) {
      console.warn("Falló lectura con:", url, e);
    }
  }
  return null;
}

async function readQR(url) {
  // Esto puede fallar por CORS (Drive no da Access-Control-Allow-Origin).
  const res = await fetch(url, { method: "GET" });
  if (!res.ok) throw new Error(`No se pudo descargar la imagen (${res.status})`);

  const blob = await res.blob();
  const bitmap = await createImageBitmap(blob);

  const canvas = document.createElement("canvas");
  canvas.width = bitmap.width;
  canvas.height = bitmap.height;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(bitmap, 0, 0);

  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const qr = jsQR(imgData.data, canvas.width, canvas.height);

  if (!qr || !qr.data) return null;

  const match = String(qr.data).match(/(?:\?|&)secret=([^&\s]+)/i);
  if (!match) return null;

  return decodeURIComponent(match[1]).trim();
}
</script>
</body>
</html>
